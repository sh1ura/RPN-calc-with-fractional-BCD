# 分数計算による誤差なしRPN電卓 (Arduino IDE用)

マイコンを用いたRPN計算機のソースコードです。以下の特徴があります。
- 分母・分子にそれぞれ無限長整数を用いた分数の計算により，割り算を行っても誤差のない計算が可能
- 分数表示と小数表示の切り替えが可能
- 深いスタックとアンドゥバッファにより、複雑な計算や、そのやり直しが可能
- 単純さ，簡単さを優先したコード（そのかわり遅い）
- 外部ライブラリ不要（表示デバイスの制御除く）
  
同様の計算方法によるウェブアプリ版（JavaScript実装）は、[こちら](https://shiura.com/html5/index.html)にあります。

[![レトロ電卓の再生：誤差ゼロ、アンドゥ機能付きRPN電卓](https://github.com/user-attachments/assets/fe4507ce-e2fb-4d1b-8999-07eaf46a6cf3)](https://www.youtube.com/watch?v=NmWKcKjnXug)

### 解説・特徴

- 普通の電卓に備わるキーで過不足なくRPN（逆ポーランド法）の操作ができます
  * '-' の長押しで符号反転
  * '÷' の長押しで SWAP （スタックトップ２つの入れ替え）
  * 'C' で DROP（スタックトップ削除）　ただし数値入力中は１文字消去
  * ▶ でアンドゥ
- 提供コードはカシオの初期の電卓「カシオミニ CM-602」を改造した場合を前提に作成されていますが、キー入力と表示デバイス関係を小変更することで、他のハードウェアで利用できます。
  * キーマップやGPIOポート割当てを、使用する電卓のハードウェア・配線に合わせて変更ください。
  * 表示デバイスに異なる部品を使用している場合は、その部分も修正ください。
  * RP2040 のほか、ESP32 等でも動作するはずです。
  * Arduino Nano 等でも動きますがスタック、アンドゥバッファを小さくする必要があります。

### 使用デバイス
- カシオミニ CM-602 の故障品
  * キーボードとプリント基板、外装、電池ボックスを使用します。
  * 電子部品や蛍光表示管(VFD)はすべて取り外し、スイッチだけ残します。
  * 下層の電源基板は全部取り外します（使用しません）。
- RP2040-zero
  * WaveShare の純正品、もしくは互換品を使用します。
  * 互換品なら中国通販で１個200円以下、[国内発送でも350円程度](https://shop.talpkeyboard.com/products/rp2040-zero-usb-c-compatible)で売られています。
  * 幅が CM-602 オリジナルCPUと同じため、その部分に差し込んで使います。
  * スペースの都合で裏側に装着しますので、ピンソケットを上面に取り付けます。
- ディスプレイ
  * [AQM1602Y-NLW-FBW](https://akizukidenshi.com/catalog/g/g112486/) を使用しました（カシオミニの表示窓にピッタリの大きさです）。2025/10現在、645円です。
  * 回路は[こちら](https://qiita.com/aknm21/items/e67ecc6aa5c9a8cc312d)を参考にしました。ただしLEDを明るくするため、抵抗は100Ωにしています。
  * バックライトや制御LSI ST7032 に印加する電圧は 5V です。
  * I2C 接続の SDA, SCL はレベルシフタを用いずに RP2040 に直結しています。

## 配線
### 元のカシオミニの配線
![wiring1](https://github.com/user-attachments/assets/88930761-2f87-40f6-b2e6-26c5f5631fec)
- この種の電卓の常で、表示デバイス（VFD）の桁スキャンとキースキャンの出力が兼用（同時）となっています。
- 桁スキャンのうち２個だけをキースキャンに使用し、入力端子は10個、というアンバランスな設計です。
- キーは同時押しを想定せず、ダイオードが用いられていません（ただしスライドスイッチと 0 のところだけダイオードあり）

### 改造後の配線
![wiring2](https://github.com/user-attachments/assets/e08f27d5-3f01-4efd-bc8e-458cbff4761b)
- RP2040-Zero はこの写真に対して裏返しに取り付けます。
- ほとんどすべてのキースキャンの配線は、プリント基板の配線がそのまま使用できます。
- 端子が余分にあるため、ダイオードを外して、スライドスイッチと 0 は別々の入力ポートで調べるようにしています（スイッチは入りっぱなしになり、キーの押しっぱなしと同じ効果を持つため）
- キースキャンの A, B と、スライドスイッチのみジャンパー接続しています。
- 電源は電池から 5V に直結しています。ニッケル水素電池では問題ないと思われますが、アルカリ電池の新品は電圧が高すぎるので壊れる可能性があります。
- LCD は RP2040-Zero の端子 12(SDA), 13(SCL) と 5V, GND に直結しています。

### 部品取り付け後の様子
![finish1](https://github.com/user-attachments/assets/3a3e6790-fca0-40a1-ab3a-11a9e2491152)
![finish2](https://github.com/user-attachments/assets/3a00cddd-c2d3-47a5-b350-993e6ce1b968)
- 表示部を筐体の表示窓直下に配置するため、プリント基板の不要な部分をカットしてスペースを空けています。

## コードについて
- 整数演算部では負の値は扱いません。
  * 整数は文字列で表しています（BCD風ですが、１桁あたり8bit char です）。
  * 引き算は，必ず結果が非負になるように呼び出す必要があります。
- 分数演算部では速度を気にせずコーディングしています
  * 負数を扱うための符号は、分数の構造体に入っています。
  * 乗除算は，まず計算してしまってから約分しています。
  * 加減算では最大公約数を用いずに通分してから最後に約分しています。
  * この電卓では平方根の計算ができないため、すべての演算が分数により誤差なし演算されます。
- 小数の入力は即座に分数として入力されます
  * 例えば 1.24 は 124/100 として入力され、その瞬間には約分されません（入力値を視認するため）。
  * 何らかの演算をすると自動的に約分されます。1をかけるか、0を足すかすることでも約分できます。
- スタックは16段、アンドゥバッファは32段にしています
  * RP2040 はメモリが多いため、もっと大きくできるはずです。
  * ESP32 でも同等以上に動作するはずです。
  * Arduino nano で動作させる場合はスタック８段、アンドゥ１回程度に制限しないとメモリ不足で不安定になります。
  * その他のマイコンではメモリ容量に応じて調整してください。
- 表示文字列はディスプレイの桁数に応じて自動的に短縮されます
  * 小数では 1.23e20 のような、また分数でも 2.34e12/6.77e20 のような指数表記が行われます。
  * 内部演算では指数表現は用いられません。DEBUG を 1 にしてコンパイルすると、シリアルモニタで分数構造体内の分母・分子の整数がすべて表示されます。
